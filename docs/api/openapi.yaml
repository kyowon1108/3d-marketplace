openapi: "3.1.0"
info:
  title: 3D Marketplace API
  version: "0.1.0"
  description: AR-powered 3D product marketplace API

servers:
  - url: http://localhost:8000
    description: Local development

paths:
  /v1/model-assets/uploads/init:
    post:
      operationId: initUpload
      summary: Initialize presigned upload targets
      tags: [uploads]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadInitRequest"
      responses:
        "200":
          description: Presigned URLs issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadInitResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/model-assets/uploads/complete:
    post:
      operationId: completeUpload
      summary: Verify uploaded files and transition to READY
      tags: [uploads]
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadCompleteRequest"
      responses:
        "200":
          description: Upload verified
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadCompleteResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          $ref: "#/components/responses/Conflict"

  /v1/model-assets/{assetId}:
    get:
      operationId: getModelAsset
      summary: Get model asset status
      tags: [model-assets]
      security:
        - bearerAuth: []
      parameters:
        - name: assetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Asset details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModelAssetResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/products/publish:
    post:
      operationId: publishProduct
      summary: Publish a READY asset as a product
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PublishRequest"
      responses:
        "201":
          description: Product published
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"

  /v1/products:
    get:
      operationId: listProducts
      summary: List published products
      tags: [products]
      security:
        - bearerAuth: []
        - {}
      parameters:
        - name: q
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: seller_id
          in: query
          description: Filter products by seller UUID
          schema:
            type: string
            format: uuid
        - name: liked
          in: query
          description: "If true, return only products liked by the authenticated user (requires auth)"
          schema:
            type: boolean
      responses:
        "200":
          description: Product list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductListResponse"

  /v1/products/{id}:
    get:
      operationId: getProduct
      summary: Get product detail
      tags: [products]
      security:
        - bearerAuth: []
        - {}
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Product detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      operationId: updateProduct
      summary: Update product fields (title, description, price)
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductUpdateRequest"
      responses:
        "200":
          description: Product updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      operationId: deleteProduct
      summary: Soft-delete a product
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Product deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/products/{id}/status:
    patch:
      operationId: changeProductStatus
      summary: Change product status (FOR_SALE, RESERVED, SOLD_OUT)
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StatusChangeRequest"
      responses:
        "200":
          description: Status changed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/products/{id}/like:
    post:
      operationId: toggleProductLike
      summary: Toggle like on a product
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Like toggled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LikeToggleResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/products/{id}/purchase:
    post:
      operationId: purchaseProduct
      summary: Purchase a product (creates purchase record and marks product SOLD_OUT)
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "201":
          description: Purchase created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PurchaseResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/products/{id}/ar-asset:
    get:
      operationId: getProductArAsset
      summary: Get AR asset for a product
      tags: [products]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: AR asset info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ArAssetResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/products/{id}/chat-rooms:
    post:
      operationId: createProductChatRoom
      summary: Create a chat room for a product
      tags: [chat]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateChatRoomRequest"
      responses:
        "201":
          description: Chat room created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatRoomResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/chat-rooms:
    get:
      operationId: listChatRooms
      summary: List user's chat rooms
      tags: [chat]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Chat room list
          content:
            application/json:
              schema:
                type: object
                properties:
                  rooms:
                    type: array
                    items:
                      $ref: "#/components/schemas/ChatRoomResponse"
                required:
                  - rooms
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/chat-rooms/{roomId}/read:
    post:
      operationId: markChatRoomRead
      summary: Mark all messages in a chat room as read
      tags: [chat]
      security:
        - bearerAuth: []
      parameters:
        - name: roomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Room marked as read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatRoomResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/chat-rooms/{roomId}/messages:
    get:
      operationId: getChatMessages
      summary: Get messages in a chat room
      tags: [chat]
      security:
        - bearerAuth: []
      parameters:
        - name: roomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: before
          in: query
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        "200":
          description: Message list
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/ChatMessageResponse"
                required:
                  - messages
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      operationId: sendChatMessage
      summary: Send a message in a chat room
      tags: [chat]
      security:
        - bearerAuth: []
      parameters:
        - name: roomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendMessageRequest"
      responses:
        "201":
          description: Message sent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatMessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/chat-images/upload:
    post:
      operationId: uploadChatImage
      summary: Upload a chat image (AR screenshot, etc.)
      tags: [chat]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Image file (JPEG, PNG, or WebP). Max 20MB.
              required:
                - file
      responses:
        "200":
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatImageUploadResponse"
        "400":
          description: Invalid file type or empty file
        "413":
          description: File too large (max 20MB)
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/ai/suggest-listing:
    post:
      operationId: aiSuggestListing
      summary: AI-powered listing title and description suggestion
      tags: [ai]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AISuggestListingRequest"
      responses:
        "200":
          description: AI suggestion generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AISuggestListingResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          description: AI service error
        "503":
          description: AI service not configured

  /v1/auth/providers:
    get:
      operationId: getAuthProviders
      summary: List available auth providers
      tags: [auth]
      responses:
        "200":
          description: Provider list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthProvidersResponse"

  /v1/auth/oauth/{provider}/callback:
    get:
      operationId: oauthCallback
      summary: OAuth callback handler
      tags: [auth]
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Auth token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokenResponse"

  /v1/auth/oauth/{provider}/token:
    post:
      operationId: oauthTokenExchange
      summary: Mobile OAuth token exchange (iOS sends provider id_token)
      tags: [auth]
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GoogleTokenRequest"
      responses:
        "200":
          description: Auth token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/auth/token/refresh:
    post:
      operationId: refreshToken
      summary: Refresh access token using refresh token
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenRefreshRequest"
      responses:
        "200":
          description: New token pair
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenRefreshResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/auth/logout:
    post:
      operationId: logout
      summary: Revoke refresh token (logout)
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogoutRequest"
      responses:
        "204":
          description: Logged out

  /v1/auth/me:
    get:
      operationId: getCurrentUser
      summary: Get current authenticated user
      tags: [auth]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    patch:
      operationId: updateCurrentUser
      summary: Update current user profile (name, location)
      tags: [auth]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdateRequest"
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/me/purchases:
    get:
      operationId: getMyPurchases
      summary: List current user's purchase history
      tags: [auth]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Purchase list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PurchaseListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/me/summary:
    get:
      operationId: getUserSummary
      summary: Get user summary stats
      tags: [auth]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSummaryResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/chats/{roomId}:
    get:
      operationId: websocketChat
      summary: WebSocket chat connection
      description: |
        Upgrades to WebSocket for real-time chat messaging.
        Authentication via `?token=<jwt>` query parameter.

        Close codes:
        - 4001: Missing or invalid token
        - 4003: Not a participant in this room

        Inbound message format: `{"body": "message text", "image_url": "https://...(optional)"}`
        Outbound message format: `{"type": "message", "id": "uuid", "room_id": "uuid", "sender_id": "uuid", "body": "text", "message_type": "TEXT|IMAGE", "image_url": "...|null", "created_at": "iso8601"}`

        Messages are persisted to the database and broadcast to all room participants.
      tags: [chat]
      parameters:
        - name: roomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: token
          in: query
          required: true
          description: JWT access token for authentication
          schema:
            type: string
      responses:
        "101":
          description: WebSocket upgrade successful

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
      required:
        - error

    # --- Upload ---
    ImageInitMeta:
      type: object
      properties:
        image_type:
          type: string
          enum: [THUMBNAIL, DISPLAY]
        sort_order:
          type: integer
          default: 0
        size_bytes:
          type: integer
      required:
        - image_type
        - size_bytes

    ImageCompleteMeta:
      type: object
      properties:
        image_type:
          type: string
          enum: [THUMBNAIL, DISPLAY]
        sort_order:
          type: integer
        size_bytes:
          type: integer
        checksum_sha256:
          type: string
      required:
        - image_type
        - sort_order
        - size_bytes
        - checksum_sha256

    UploadInitRequest:
      type: object
      properties:
        dims_source:
          type: string
          enum: [ios_lidar, ios_manual, unknown]
        dims_width:
          type: number
          nullable: true
        dims_height:
          type: number
          nullable: true
        dims_depth:
          type: number
          nullable: true
        capture_session_id:
          type: string
          format: uuid
          nullable: true
        files:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [MODEL_USDZ, MODEL_GLB, PREVIEW_PNG]
              size_bytes:
                type: integer
            required:
              - role
              - size_bytes
        images:
          type: array
          items:
            $ref: "#/components/schemas/ImageInitMeta"
          default: []
      required:
        - files

    PresignedImageTarget:
      type: object
      properties:
        image_type:
          type: string
        sort_order:
          type: integer
        url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time
      required:
        - image_type
        - sort_order
        - url
        - expires_at

    UploadInitResponse:
      type: object
      properties:
        asset_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [UPLOADING]
        presigned_uploads:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
              url:
                type: string
                format: uri
              expires_at:
                type: string
                format: date-time
            required:
              - role
              - url
              - expires_at
        presigned_image_uploads:
          type: array
          items:
            $ref: "#/components/schemas/PresignedImageTarget"
          default: []
      required:
        - asset_id
        - status
        - presigned_uploads

    UploadCompleteRequest:
      type: object
      properties:
        asset_id:
          type: string
          format: uuid
        files:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [MODEL_USDZ, MODEL_GLB, PREVIEW_PNG]
              size_bytes:
                type: integer
              checksum_sha256:
                type: string
            required:
              - role
              - size_bytes
              - checksum_sha256
        images:
          type: array
          items:
            $ref: "#/components/schemas/ImageCompleteMeta"
          default: []
      required:
        - asset_id
        - files

    ImageVerifyResult:
      type: object
      properties:
        image_type:
          type: string
        sort_order:
          type: integer
        verified:
          type: boolean
      required:
        - image_type
        - sort_order
        - verified

    UploadCompleteResponse:
      type: object
      properties:
        asset_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [READY]
        files:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
              verified:
                type: boolean
            required:
              - role
              - verified
        image_results:
          type: array
          items:
            $ref: "#/components/schemas/ImageVerifyResult"
          default: []
      required:
        - asset_id
        - status
        - files

    # --- Model Asset ---
    AssetImageInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        image_type:
          type: string
          enum: [THUMBNAIL, DISPLAY]
        storage_key:
          type: string
        size_bytes:
          type: integer
        sort_order:
          type: integer
      required:
        - id
        - image_type
        - storage_key
        - size_bytes
        - sort_order

    ModelAssetResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        owner_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [INITIATED, UPLOADING, READY, FAILED, PUBLISHED]
        availability:
          type: string
          enum: [READY, PROCESSING, NONE]
        dims_source:
          type: string
          enum: [ios_lidar, ios_manual, unknown]
          nullable: true
        dims_width:
          type: number
          nullable: true
        dims_height:
          type: number
          nullable: true
        dims_depth:
          type: number
          nullable: true
        files:
          type: array
          items:
            $ref: "#/components/schemas/AssetFileInfo"
        images:
          type: array
          items:
            $ref: "#/components/schemas/AssetImageInfo"
          default: []
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - owner_id
        - status
        - availability
        - files
        - created_at
        - updated_at

    AssetFileInfo:
      type: object
      properties:
        role:
          type: string
        storage_key:
          type: string
        size_bytes:
          type: integer
        checksum_sha256:
          type: string
      required:
        - role
        - storage_key
        - size_bytes
        - checksum_sha256

    # --- AR Asset ---
    ArAssetResponse:
      type: object
      properties:
        availability:
          type: string
          enum: [READY, PROCESSING, NONE]
        asset_id:
          type: string
          format: uuid
          nullable: true
        files:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
              url:
                type: string
                format: uri
              type:
                type: string
                enum: [model, preview]
            required:
              - role
              - url
              - type
        dims_source:
          type: string
          enum: [ios_lidar, ios_manual, unknown]
          nullable: true
        dims_trust:
          type: string
          enum: [high, medium, low]
          nullable: true
        dims_width:
          type: number
          format: float
          nullable: true
          description: Width in centimeters
        dims_height:
          type: number
          format: float
          nullable: true
          description: Height in centimeters
        dims_depth:
          type: number
          format: float
          nullable: true
          description: Depth in centimeters
      required:
        - availability
        - files

    # --- AI Suggest ---
    AISuggestListingRequest:
      type: object
      properties:
        thumbnail_url:
          type: string
          format: uri
        dims_width:
          type: number
          format: float
          nullable: true
        dims_height:
          type: number
          format: float
          nullable: true
        dims_depth:
          type: number
          format: float
          nullable: true
        dims_source:
          type: string
          nullable: true
      required:
        - thumbnail_url

    AISuggestListingResponse:
      type: object
      properties:
        suggested_title:
          type: string
        suggested_description:
          type: string
      required:
        - suggested_title
        - suggested_description

    # --- Product ---
    ProductUpdateRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
          nullable: true
        price_cents:
          type: integer

    StatusChangeRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/ProductStatus"
      required:
        - status

    UserUpdateRequest:
      type: object
      properties:
        name:
          type: string
        location_name:
          type: string
          nullable: true

    PublishRequest:
      type: object
      properties:
        asset_id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        price_cents:
          type: integer
      required:
        - asset_id
        - title
        - price_cents

    ProductStatus:
      type: string
      enum: [FOR_SALE, RESERVED, SOLD_OUT]

    ProductResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        asset_id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
          nullable: true
        price_cents:
          type: integer
        seller_id:
          type: string
          format: uuid
        published_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        seller_name:
          type: string
          default: ""
        seller_avatar_url:
          type: string
          nullable: true
        thumbnail_url:
          type: string
          nullable: true
        status:
          $ref: "#/components/schemas/ProductStatus"
        likes_count:
          type: integer
          default: 0
        views_count:
          type: integer
          default: 0
        chat_count:
          type: integer
          default: 0
        seller_location_name:
          type: string
          nullable: true
        is_liked:
          type: boolean
          nullable: true
      required:
        - id
        - asset_id
        - title
        - price_cents
        - seller_id
        - created_at

    ProductListResponse:
      type: object
      properties:
        products:
          type: array
          items:
            $ref: "#/components/schemas/ProductResponse"
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
      required:
        - products
        - total
        - page
        - limit

    PurchaseResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        buyer_id:
          type: string
          format: uuid
        price_cents:
          type: integer
        purchased_at:
          type: string
          format: date-time
        product:
          $ref: "#/components/schemas/ProductResponse"
      required:
        - id
        - product_id
        - buyer_id
        - price_cents
        - purchased_at

    PurchaseListResponse:
      type: object
      properties:
        purchases:
          type: array
          items:
            $ref: "#/components/schemas/PurchaseResponse"
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
      required:
        - purchases
        - total
        - page
        - limit

    LikeToggleResponse:
      type: object
      properties:
        liked:
          type: boolean
        likes_count:
          type: integer
      required:
        - liked
        - likes_count

    # --- Chat ---
    CreateChatRoomRequest:
      type: object
      properties:
        subject:
          type: string
      required:
        - subject

    ChatRoomResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        buyer_id:
          type: string
          format: uuid
        seller_id:
          type: string
          format: uuid
        subject:
          type: string
        created_at:
          type: string
          format: date-time
        last_message_at:
          type: string
          format: date-time
          nullable: true
        last_message_body:
          type: string
          nullable: true
        unread_count:
          type: integer
          default: 0
        buyer_name:
          type: string
          default: ""
        seller_name:
          type: string
          default: ""
        product_title:
          type: string
          default: ""
        product_thumbnail_url:
          type: string
          nullable: true
      required:
        - id
        - product_id
        - buyer_id
        - seller_id
        - subject
        - created_at

    ChatMessageResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        room_id:
          type: string
          format: uuid
        sender_id:
          type: string
          format: uuid
        body:
          type: string
        message_type:
          type: string
          enum: [TEXT, IMAGE]
          default: TEXT
        image_url:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
      required:
        - id
        - room_id
        - sender_id
        - body
        - message_type
        - created_at

    SendMessageRequest:
      type: object
      properties:
        body:
          type: string
        image_url:
          type: string
          nullable: true
          description: HTTP(S) URL of an uploaded chat image
      required:
        - body

    ChatImageUploadResponse:
      type: object
      properties:
        image_url:
          type: string
      required:
        - image_url

    # --- Auth ---
    AuthProvidersResponse:
      type: object
      properties:
        providers:
          type: array
          items:
            type: string
      required:
        - providers

    AuthTokenResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
          nullable: true
        token_type:
          type: string
        expires_in:
          type: integer
          nullable: true
        user:
          $ref: "#/components/schemas/UserResponse"
      required:
        - access_token
        - token_type
        - user

    GoogleTokenRequest:
      type: object
      properties:
        id_token:
          type: string
          nullable: true
        code:
          type: string
          nullable: true

    TokenRefreshRequest:
      type: object
      properties:
        refresh_token:
          type: string
      required:
        - refresh_token

    TokenRefreshResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
        expires_in:
          type: integer
      required:
        - access_token
        - refresh_token
        - token_type
        - expires_in

    LogoutRequest:
      type: object
      properties:
        refresh_token:
          type: string
      required:
        - refresh_token

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string
        provider:
          type: string
        avatar_url:
          type: string
          nullable: true
        trust_score:
          type: number
          format: float
          default: 36.5
        location_name:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
      required:
        - id
        - email
        - name
        - provider
        - created_at

    UserSummaryResponse:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/UserResponse"
        product_count:
          type: integer
        unread_messages:
          type: integer
      required:
        - user
        - product_count
        - unread_messages
